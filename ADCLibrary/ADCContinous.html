<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ADC Continous  - Advanced Computer Engineering</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././theme/pagetoc.css">
        <link rel="stylesheet" href=".././theme/css/mdbook-admonish.css">
        <link rel="stylesheet" href=".././theme/css/code.css">
        <link rel="stylesheet" href=".././theme/css/terminal.css">
        <link rel="stylesheet" href=".././theme/css/output.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="burgundy">Burgundy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="dracula">Dracula</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ecoFriend">EcoFriend</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="pinkrose">Pinkrose</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="space">Space</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="sustain">Sustain</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="tokyonight">Tokyonight</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Advanced Computer Engineering</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/uniofgreenwich/ELEE1119_Exercises" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/uniofgreenwich/ELEE1119_Exercises/edit/main/src/ADCLibrary/ADCContinous.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main><div class="sidetoc"><nav class="pagetoc"></nav></div>
                        <h1 id="adc-library---continous-measurements"><a class="header" href="#adc-library---continous-measurements">ADC Library - Continous measurements</a></h1>
<pre><code class="language-admonish warning">
- You need to have finished [ADCLibrary section](./ADCLibrary.md)

</code></pre>
<h2 id="1-important-information"><a class="header" href="#1-important-information">1. Important information</a></h2>
<p>So far we are reading analog voltages in one-shot mode. Most applications need continuous reading of input values. For continuous mode, we need a buffer to capture the input values while the BBB is doing something else.</p>
<p>Important folders in the iio:deviceX directory are:</p>
<ul>
<li>
<p><code>buffer\</code></p>
<ul>
<li><code>enable</code>: get and set the state of the buffer</li>
<li><code>length</code>: get and set the length of the buffer.</li>
</ul>
</li>
<li>
<p>The buffer can be enabled by doing:</p>
<pre><code class="language-admonish terminal">
```
debian@beaglebone:~# echo 1 &gt; /sys/bus/iio/devices/iio\:device0/scan_elements/in_voltage0_en
debian@beaglebone:~# echo 100 &gt; /sys/bus/iio/devices/iio\:device0/buffer/length
debian@beaglebone:~# echo 1 &gt; /sys/bus/iio/devices/iio\:device0/buffer/enable
```

</code></pre>
</li>
</ul>
<p>The first line tells which analog channel to scan. Just change the x in in_voltagex_en if you need a different analog channel. The second line specifies the length of the buffer and the last line enables the buffer.</p>
<ul>
<li>
<p><code>scan_elements</code> directory contains interfaces for elements that will be captured for a single sample set in the buffer.</p>
<pre><code class="language-admonish output">
```bash
debian@beaglebone:~# ls -al /sys/bus/iio/devices/iio\:device0/scan_elements/
drwxr-xr-x    2 root     root            0 Jan  1 00:00 .
drwxr-xr-x    5 root     root            0 Jan  1 00:00 ..
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage0_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage0_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage0_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage1_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage1_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage1_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage2_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage2_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage2_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage3_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage3_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage3_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage4_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage4_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage4_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage5_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage5_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage5_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage6_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage6_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage6_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage7_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage7_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage7_type
```

</code></pre>
</li>
<li>
<p><code>scan_elements</code> exposes 3 files per channel:</p>
<ul>
<li><code>in_voltageX_en</code>: is this channel enabled?</li>
<li><code>in_voltageX_index</code>: index of this channel in the bufferâ€™s chunks</li>
<li><code>in_voltageX_type</code> : How the ADC stores its data. Reading this file should return you a string something like below:</li>
</ul>
<pre><code class="language-admonish terminal">
```bash
debian@beaglebone:~# cat /sys/bus/iio/devices/iio\:device0/scan_elements/in_voltage1_type
le:u12/16&gt;&gt;0
```
</code></pre>
<pre><code class="language-admonish example title=&#39;Output Explanation&#39;">
Where:

- `le` represents the endianness, here little endian
- `u` is the sign of the value returned. It could be either `u` (for unsigned) or `s` (for signed)
- `12` is the number of relevant bits of information
- `16` is the actual number of bits used to store the datum
- `0` is the number of right shifts needed.
</code></pre>
</li>
</ul>
<p>When the ADC sequencer finishes cycling through all the enabled channels, the user can decide if the sequencer should stop (one-shot mode), or loop back and schedule again (continuous mode). If one-shot mode is enabled, then the sequencer will only be scheduled one time (the sequencer HW will automatically disable the StepEnable bit after it is scheduled which will guarantee only one sample is taken per channel). When the user wants to continuously take samples, continuous mode needs to be enabled. One cannot read ADC data from one channel operating in One-shot mode and and other in continuous mode at the same time.</p>
<h2 id="2-updating-adch"><a class="header" href="#2-updating-adch">2. Updating <code>adc.h</code></a></h2>
<p>You need to update the adc.h header file to take advantage of the continous mode offered by the ADC chip:</p>
<ul>
<li>
<p>We are adding adding the following macros:</p>
<pre><code class="language-admonish code">
```h
#define SYSFS_ADC_ENABLE_PATH "/sys/bus/iio/devices/iio:device0/buffer/enable"
#define SYSFS_ADC_LENGTH_PATH "/sys/bus/iio/devices/iio:device0/buffer/length"
#define SYSFS_ADC_SCAN_DIR "/sys/bus/iio/devices/iio:device0/scan_elements"

... 

#define ADC_BUF 6
#define REFVOLTAGE 1.8
#define MAXADC 4096
#define MAX_SAMPLE_RATE 2000000 // 200kSPS
```

</code></pre>
</li>
<li>
<p>Additionally we are adding the following prototypes:</p>
<pre><code class="language-admonish code">
```h
int adc_to_voltage(unsigned int adcValue, float *voltage);
int adc_get_buffer(unsigned int adcPin, unsigned int *value);
int enable_channel(unsigned int adcPin);
int disable_channel(unsigned int adcPin);
int enable_buffer(void);
int disable_buffer(void);
int set_buffer_length(unsigned int len);
```

</code></pre>
<pre><code class="language-admonish code collapsible=true title=&#39;Complete code here [48 lines]&#39;">```h
#ifndef ADC_H_
#define ADC_H_

/**************************************************
* Contents                                       *
* ***********************************************/

#define SYSFS_ADC_DIR "/sys/bus/iio/devices/iio:device0"
#define SYSFS_ADC_ENABLE_PATH "/sys/bus/iio/devices/iio:device0/buffer/enable"
#define SYSFS_ADC_LENGTH_PATH "/sys/bus/iio/devices/iio:device0/buffer/length"
#define SYSFS_ADC_SCAN_DIR "/sys/bus/iio/devices/iio:device0/scan_elements"

#define POLL_TIMEOUT (3 * 1000) /*3 seconds*/

#define MAX_BUF 256
#define MAX_LEN_BUF 100
#define ADC_BUF 6
#define REFVOLTAGE 1.8
#define MAXADC 4096
#define MAX_SAMPLE_RATE 2000000 // 200kSPS

/************************************************
* ADC RELATED                                  *
************************************************/
int adc_get_value(unsigned int adcPin, unsigned int *value);
int adc_fd_open(unsigned int gpio);
int adc_fd_close(unsigned int fd);
int adc_to_voltage(unsigned int adcValue, float *voltage);
int adc_get_buffer(unsigned int adcPin, unsigned int *value);
int enable_channel(unsigned int adcPin);
int disable_channel(unsigned int adcPin);
int enable_buffer(void);
int disable_buffer(void);
int set_buffer_length(unsigned int len);

#endif /* ADC_H_*/
```

</code></pre>
</li>
</ul>
<h2 id="3-updating-adcc"><a class="header" href="#3-updating-adcc">3. Updating <code>adc.c</code></a></h2>
<p>Now we need to update <code>adc.c</code> to create the functionality of our new prototypes:</p>
<ol>
<li>
<p>Starting with <code>int enable_channel(...);</code>:</p>
<p>Add to the bottom of the <code>adc.c</code> file:</p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [23 lines]&#39;">
```c
/***************************************************************
* enable_channel
****************************************************************/

int enable_channel(unsigned int adcPin){

    int fd;
    char buf[MAX_BUF];

    snprintf(buf, sizeof(buf),SYSFS_ADC_SCAN_DIR "/in_voltage%d_en", adcPin); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/scan_element/");
        return fd; 
    }

    // to enable continous mode
    write(fd, "1", 2);
    close(fd);

    return 0;

}
```

</code></pre>
</li>
<li>
<p>Likewise of <code>int disable_channel(...)</code>, you only need to modify the <code>write()</code>... as <code>write(fd, "0",2);</code></p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [23 lines]&#39;">
```c
/***************************************************************
* disable_channel
****************************************************************/

int disable_channel(unsigned int adcPin){

    int fd;
    char buf[MAX_BUF];

    snprintf(buf, sizeof(buf),SYSFS_ADC_SCAN_DIR "/in_voltage%d_en", adcPin); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/scan_element/");
        return fd; 
    }

    // to disable continous mode
    write(fd, "0", 2);
    close(fd);

    return 0;

}
```

</code></pre>
</li>
<li>
<p>Next we need to do the same for <code>enable_buffer()</code> and <code>disable_buffer()</code></p>
<ul>
<li>
<p><code>int enable_buffer(void);</code></p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [23 lines]&#39;">
```c
/***************************************************************
* enable_buffer
****************************************************************/

int enable_buffer(void){

    int fd;
    char buf[MAX_BUF];

    // to enable continous mode
    snprintf(buf, sizeof(buf),SYSFS_ADC_ENABLE_PATH); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/buffer/enable");
        return fd; 
    }

    write(fd, "1", 2);
    close(fd);

    return 0;
}
```

</code></pre>
</li>
<li>
<p>Likewise of <code>int disable_buffer(...)</code>, you only need to modify the <code>write()</code>... as <code>write(fd, "0",2);</code>:</p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [23 lines]&#39;">
```c
/***************************************************************
* disable_buffer
****************************************************************/

int disable_buffer(void){

    int fd;
    char buf[MAX_BUF];

    // to enable continous mode
    snprintf(buf, sizeof(buf),SYSFS_ADC_ENABLE_PATH); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/buffer/enable");
        return fd; 
    }

    write(fd, "0", 2);
    close(fd);

    return 0;

}
```

</code></pre>
</li>
</ul>
</li>
<li>
<p>Next we need to set the buffer length as to store <em>n</em> values:</p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [25 lines]&#39;">
```c
/***************************************************************
* set_buffer_length
****************************************************************/

int set_buffer_length(unsigned int len){

    int fd;
    char buf[MAX_BUF];
    char lenBuf[MAX_LEN_BUF];

    snprintf(buf, sizeof(buf),SYSFS_ADC_LENGTH_PATH);

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/buffer/length");
        return fd; 
    }

    snprintf(lenBuf, sizeof(lenBuf),"%d",len);

    write(fd, lenBuf, sizeof(lenBuf));
    close(fd);

    return 0;

}
```

</code></pre>
</li>
<li>
<p>Lastly, for the adc continous mode, we need to create the <code>adc_get_buffer(...)</code>:</p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [23 lines]&#39;">
```c
/****************************************************************
* adc_get_buffer
****************************************************************/
int adc_get_buffer(unsigned int adcPin, unsigned int *value) {
    int fd;
    char buf[MAX_BUF];
    char retChars[ADC_BUF];

    // Path to buffered ADC values
    snprintf(buf, sizeof(buf), SYSFS_ADC_DIR "/in_voltage%d_raw", adcPin);

    // Open the buffer file
    fd = open(buf, O_RDONLY | O_NONBLOCK);
    if (fd &lt; 0) {
        perror("adc/get-buffer");
        return fd;
    }

    // Read buffer data
    ssize_t bytesRead = read(fd, retChars, sizeof(retChars));
    if (bytesRead &lt; 0) {
        perror("adc/get-buffer/read");
        close(fd);
        return -1;
    }

    // Convert the read data to an integer value
    *value = strtol(retChars, NULL, 0);

    close(fd);
    return 0;
}
```

</code></pre>
</li>
<li>
<p>We also made a prototype to do the voltage conversion for adc, make the <code>int adc_to_voltage(unsigned adcValue, float *voltage){}</code>:</p>
<ul>
<li>
<p>Try make this yourself first, implement this equation and make reference to the macros, <code>REFVOLTAGE</code> and <code>MAXADC</code>:</p>
<p>\[ V_{in} = \frac{adcValue\ \cdot\ V_{ref}}{2^n - 1} \]</p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [5 lines]&#39;">
```c
int adc_to_voltage(unsigned adcValue, float *voltage){

    *voltage = ( ( (float)adcValue * REFVOLTAGE ) / (float)MAXADC );

return 0;
}
```

</code></pre>
<pre><code class="language-admonish important">
Remember that you are peforming mathematical operations on whole numbers and decimals numbers, you may need to `cast`.

</code></pre>
</li>
</ul>
</li>
<li>
<p>Remember to use make to update the libraries:</p>
<p><img src="./figures/make_adc.gif" alt="" /></p>
</li>
</ol>
<h2 id="4-make-a-programme-to-utilise-the-continous-capibilities"><a class="header" href="#4-make-a-programme-to-utilise-the-continous-capibilities">4. Make a programme to utilise the continous capibilities</a></h2>
<ol>
<li>
<p>Create a directory whether you are storing your implementations, for me I use <code>~/examples_C/adc_continous_read</code></p>
</li>
<li>
<p>Once in the directory you can create a file called <code>adc_continous_read.c</code></p>
</li>
<li>
<p>We are going to modify the file to take user input, the pin number and the size of the buffer:</p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [57 lines]&#39;">
```c
#include "adc.h"
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char *argv[]) {
    if (argc != 3) {
        fprintf(stderr, "Usage: %s &lt;adcPin&gt; &lt;bufferLength&gt;\n", argv[0]);
        return EXIT_FAILURE;
    }

    unsigned int adcPin = atoi(argv[1]);
    unsigned int bufferLength = atoi(argv[2]);
    unsigned int adcValue;
    float voltage;

    // Enable buffer and set buffer length
    if (enable_buffer() &lt; 0) {
        fprintf(stderr, "Error enabling buffer.\n");
        return EXIT_FAILURE;
    }

    if (set_buffer_length(bufferLength) &lt; 0) {
        fprintf(stderr, "Error setting buffer length.\n");
        disable_buffer();
        return EXIT_FAILURE;
    }

    // Enable ADC channel
    if (enable_channel(adcPin) &lt; 0) {
        fprintf(stderr, "Error enabling ADC channel %u.\n", adcPin);
        disable_buffer();
        return EXIT_FAILURE;
    }

    printf("Starting continuous ADC read on pin %u...\n", adcPin);

    // Continuous read loop
    for (int i = 0; i &lt; bufferLength; i++) {
        if (adc_get_buffer(adcPin, &amp;adcValue) == 0) {
            adc_to_voltage(adcValue, &amp;voltage);
            printf("ADC Value: %u, Voltage: %.3f V\n", adcValue, voltage);
        } else {
            fprintf(stderr, "Error reading buffer for ADC pin %u.\n", adcPin);
            break;
        }

        //usleep(500000); // Delay between reads (adjust as needed, e.g., 500 ms)
    }

    // Cleanup: disable buffer and channel
    disable_channel(adcPin);
    disable_buffer();

    printf("Continuous ADC read completed.\n");

    return EXIT_SUCCESS;
}
```

</code></pre>
 <p></p>
<pre><code class="language-admonish example title=&#39;Explanation of code&#39;">
Main Function
- The `main` function begins by checking the arguments. It requires two command-line arguments:
    1. `adcPin`: The ADC pin number.
    2. `bufferLength`: Number of samples to read in continuous mode.

        ```c
        int main(int argc, char *argv[]) {
            if (argc != 3) {
                fprintf(stderr, "Usage: %s &lt;adcPin&gt; &lt;bufferLength&gt;\n", argv[0]);
                return EXIT_FAILURE;
            }
        ```

    3. If the correct arguments aren't provided, it outputs an error and exits.

- Setting Up the ADC


    1. The program enables the buffer with `enable_buffer()` and sets the buffer length with `set_buffer_length(bufferLength)`. It then enables the specified ADC channel using `enable_channel(adcPin)`.


        ```c
        if (enable_buffer() &lt; 0) {
            fprintf(stderr, "Error enabling buffer.\n");
            return EXIT_FAILURE;
        }

        if (set_buffer_length(bufferLength) &lt; 0) {
            fprintf(stderr, "Error setting buffer length.\n");
            disable_buffer();
            return EXIT_FAILURE;
        }

        if (enable_channel(adcPin) &lt; 0) {
            fprintf(stderr, "Error enabling ADC channel %u.\n", adcPin);
            disable_buffer();
            return EXIT_FAILURE;
        }
        ```

- Continuous Read Loop

    1. The program enters a loop that iterates `bufferLength` times, reading ADC values using `adc_get_buffer(adcPin, &amp;adcValue)` and converting each to voltage with `adc_to_voltage(adcValue, &amp;voltage)`. Each value is printed with both its ADC and voltage readings.

        ```c
        for (int i = 0; i &lt; bufferLength; i++) {
            if (adc_get_buffer(adcPin, &amp;adcValue) == 0) {
                adc_to_voltage(adcValue, &amp;voltage);
                printf("ADC Value: %u, Voltage: %.3f V\n", adcValue, voltage);
            } else {
                fprintf(stderr, "Error reading buffer for ADC pin %u.\n", adcPin);
                break;
            }
        }
        ```

        &gt;**Note:**
        &gt;&gt; The `usleep` function is commented out here. In real applications, uncomment and adjust it to control the sample rate, if necessary.

-  Cleanup and Exit
    1. After reading, the program disables the ADC channel and buffer, and then exits.
        ```c
        disable_channel(adcPin);
        disable_buffer();
        printf("Continuous ADC read completed.\n");
        return EXIT_SUCCESS;
        ```

</code></pre>
</li>
<li>
<p>Create a <code>Makefile</code> and replicate the code below:</p>
<pre><code class="language-admonish code collapsible=true title=&#39;Suppressed code here [25 lines]&#39;">
```Makefile
# Compiler and flags
CC = gcc
CFLAGS = -Wall -Werror

# Target executable name
TARGET = adc_continuous_read

# Source files
SRC = adc_continuous_read.c

# Library to link against
LIBS = -ladc

# Default target: build the executable
all: $(TARGET)

# Build the executable
$(TARGET): $(SRC)
    $(CC) $(CFLAGS) $(SRC) $(LIBS) -o $(TARGET)

# Clean up build artifacts
clean:
    rm -f $(TARGET)

# Phony targets to avoid conflicts with files of the same name
.PHONY: all clean

```

</code></pre>
<ul>
<li>
<p>Now use <code>make</code> and compile the code and run:</p>
<p><img src="./figures/adc_continous_read.gif" alt="" /></p>
</li>
</ul>
</li>
</ol>

                    </main>
                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ADCLibrary/ADCLibrary.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../PWMLibrary/PWMLibrary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ADCLibrary/ADCLibrary.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../PWMLibrary/PWMLibrary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src=".././theme/pagetoc.js"></script>


    </div>
    </body>
</html>